<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="author" content="Ali Zaidi" />
  <meta name="dcterms.date" content="2016-11-28" />
  <title>Modeling and Scoring with RevoScaleR</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="3-modeling-scoring-rre_files/reveal.js-3.3.0/css/reveal.css"/>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="3-modeling-scoring-rre_files/reveal.js-3.3.0/css/theme/night.css" id="theme">

<style type="text/css">
.reveal section img {
  background: rgba(255, 255, 255, 0.85);
}
</style>

  <!-- some tweaks to reveal css -->
  <style type="text/css">
    .reveal h1 { font-size: 2.0em; }
    .reveal h2 { font-size: 1.5em;  }
    .reveal h3 { font-size: 1.25em;	}
    .reveal h4 { font-size: 1em;	}

    .reveal .slides>section,
    .reveal .slides>section>section {
      padding: 0px 0px;
    }



    .reveal table {
      border-width: 1px;
      border-spacing: 2px;
      border-style: dotted;
      border-color: gray;
      border-collapse: collapse;
      font-size: 0.7em;
    }

    .reveal table th {
      border-width: 1px;
      padding-left: 10px;
      padding-right: 25px;
      font-weight: bold;
      border-style: dotted;
      border-color: gray;
    }

    .reveal table td {
      border-width: 1px;
      padding-left: 10px;
      padding-right: 25px;
      border-style: dotted;
      border-color: gray;
    }

  </style>

    <style type="text/css">code{white-space: pre;}</style>

    <link rel="stylesheet" href="slides.css"/>
    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? '3-modeling-scoring-rre_files/reveal.js-3.3.0/css/print/pdf.css' : '3-modeling-scoring-rre_files/reveal.js-3.3.0/css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>
    <!--[if lt IE 9]>
    <script src="3-modeling-scoring-rre_files/reveal.js-3.3.0/lib/js/html5shiv.js"></script>
    <![endif]-->

</head>
<body>
  <div class="reveal">
    <div class="slides">

<section>
    <h1 class="title">Modeling and Scoring with RevoScaleR</h1>
    <h2 class="author">Ali Zaidi</h2>
    <h3 class="date">November 28, 2016</h3>
</section>

<section><section id="introduction" class="titleslide slide level1"><h1>Introduction</h1></section><section id="url-for-today" class="slide level2">
<h1>URL for Today</h1>
<p>Please refer to the github repository for course materials <a href="https://github.com/akzaidi/R-cadence/">github.com/akzaidi/R-cadence</a></p>
</section><section id="agenda" class="slide level2">
<h1>Agenda</h1>
<ul>
<li class="fragment">We will learn in this tutorial how to train and test models with the <code>RevoScaleR</code> package.</li>
<li class="fragment">Use your knowledge of data manipulation to create <strong>train</strong> and <strong>test</strong> sets.</li>
<li class="fragment">Use the modeling functions in <code>RevoScaleR</code> to train a model.</li>
<li class="fragment">Use the <code>rxPredict</code> function to test/score a model.</li>
<li class="fragment">We will see how you can score models on a variety of data sources.</li>
<li class="fragment">Use a functional methodology, i.e., we will create functions to automate the modeling, validation, and scoring process.</li>
</ul>
</section><section id="prerequisites" class="slide level2">
<h1>Prerequisites</h1>
<ul>
<li class="fragment">Understanding of <code>rxDataStep</code> and <code>xdfs</code></li>
<li class="fragment">Familiarity with <code>RevoScaleR</code> modeling and datastep functions: <code>rxLinMod</code>, <code>rxGlm</code>, <code>rxLogit</code>, <code>rxDTree</code>, <code>rxDForest</code>, <code>rxSplit</code>, and <code>rxPredict</code></li>
<li class="fragment">Understand how to write functions in R</li>
<li class="fragment">Access to at least one interesting dataset</li>
</ul>
</section><section id="typical-lifecycle" class="slide level2">
<h1>Typical Lifecycle</h1>
<p><img src="/home/alizaidi/mr4ds/Student-Resources/rmarkdown/images/revo-split-life-cycle.png" /></p>
<p>Typical Modeling Lifecycle:</p>
<ul>
<li class="fragment">Start with a data set</li>
<li class="fragment">Split into a training set and validation set(s)</li>
<li class="fragment">Use the <code>ScaleR</code> modeling functions on the train set to estimate your model</li>
<li class="fragment">Use <code>rxPredict</code> to validate/score your results</li>
</ul>
</section><section id="mortgage-dataset" class="slide level2">
<h1>Mortgage Dataset</h1>
<ul>
<li class="fragment">We will work with a mortgage dataset, which contains mortgage and credit profiles for various mortgage holders</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mort_path &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="kw">rxGetOption</span>(<span class="st">&quot;sampleDataDir&quot;</span>), <span class="st">&quot;mortDefaultSmall.xdf&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;/&quot;</span>)
<span class="kw">file.copy</span>(mort_path, <span class="st">&quot;mortgage.xdf&quot;</span>, <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mort_xdf &lt;-<span class="st"> </span><span class="kw">RxXdfData</span>(<span class="st">&quot;mortgage.xdf&quot;</span>)
<span class="kw">rxGetInfo</span>(mort_xdf, <span class="dt">getVarInfo =</span> <span class="ot">TRUE</span>, <span class="dt">numRows =</span> <span class="dv">5</span>)</code></pre></div>
<pre><code>## File name: /home/alizaidi/mr4ds/Student-Resources/rmarkdown/mortgage.xdf 
## Number of observations: 1e+05 
## Number of variables: 6 
## Number of blocks: 10 
## Compression type: zlib 
## Variable information: 
## Var 1: creditScore, Type: integer, Low/High: (470, 925)
## Var 2: houseAge, Type: integer, Low/High: (0, 40)
## Var 3: yearsEmploy, Type: integer, Low/High: (0, 14)
## Var 4: ccDebt, Type: integer, Low/High: (0, 14094)
## Var 5: year, Type: integer, Low/High: (2000, 2009)
## Var 6: default, Type: integer, Low/High: (0, 1)
## Data (5 rows starting with row 1):
##   creditScore houseAge yearsEmploy ccDebt year default
## 1         691       16           9   6725 2000       0
## 2         691        4           4   5077 2000       0
## 3         743       18           3   3080 2000       0
## 4         728       22           1   4345 2000       0
## 5         745       17           3   2969 2000       0</code></pre>
</section><section id="transform-default-to-categorical" class="slide level2">
<h1>Transform Default to Categorical</h1>
<ul>
<li class="fragment">We might be interested in estimating a classification model for predicting defaults based on credit attributes</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rxDataStep</span>(<span class="dt">inData =</span> mort_xdf,
           <span class="dt">outFile =</span> mort_xdf,
           <span class="dt">overwrite =</span> <span class="ot">TRUE</span>, 
           <span class="dt">transforms =</span> <span class="kw">list</span>(<span class="dt">default_flag =</span> <span class="kw">factor</span>(<span class="kw">ifelse</span>(default ==<span class="st"> </span><span class="dv">1</span>,
                                                          <span class="st">&quot;default&quot;</span>,
                                                          <span class="st">&quot;current&quot;</span>))
                             )
           )
<span class="kw">rxGetInfo</span>(mort_xdf, <span class="dt">numRows =</span> <span class="dv">3</span>, <span class="dt">getVarInfo =</span> <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## File name: /home/alizaidi/mr4ds/Student-Resources/rmarkdown/mortgage.xdf 
## Number of observations: 1e+05 
## Number of variables: 7 
## Number of blocks: 10 
## Compression type: zlib 
## Variable information: 
## Var 1: creditScore, Type: integer, Low/High: (470, 925)
## Var 2: houseAge, Type: integer, Low/High: (0, 40)
## Var 3: yearsEmploy, Type: integer, Low/High: (0, 14)
## Var 4: ccDebt, Type: integer, Low/High: (0, 14094)
## Var 5: year, Type: integer, Low/High: (2000, 2009)
## Var 6: default, Type: integer, Low/High: (0, 1)
## Var 7: default_flag
##        2 factor levels: current default
## Data (3 rows starting with row 1):
##   creditScore houseAge yearsEmploy ccDebt year default default_flag
## 1         691       16           9   6725 2000       0      current
## 2         691        4           4   5077 2000       0      current
## 3         743       18           3   3080 2000       0      current</code></pre>
</section></section>
<section><section id="modeling" class="titleslide slide level1"><h1>Modeling</h1></section><section id="generating-training-and-test-sets" class="slide level2">
<h1>Generating Training and Test Sets</h1>
<ul>
<li class="fragment">The first step to estimating a model is having a tidy training dataset.</li>
<li class="fragment">We will work with the mortgage data and use <code>rxSplit</code> to create partitions.</li>
<li class="fragment"><code>rxSplit</code> splits an input <code>.xdf</code> into multiple <code>.xdfs</code>, similar in spirit to the <code>split</code> function in base R</li>
<li class="fragment">output is a list</li>
<li class="fragment">First step is to create a split variable</li>
<li class="fragment">We will randomly partition the data into a train and test sample, with 75% in the former, and 25% in the latter</li>
</ul>
</section><section id="partition-function" class="slide level2">
<h1>Partition Function</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">create_partition &lt;-<span class="st"> </span>function(<span class="dt">xdf =</span> mort_xdf,
                             <span class="dt">partition_size =</span> <span class="fl">0.75</span>, ...) {
  <span class="kw">rxDataStep</span>(<span class="dt">inData =</span> xdf,
             <span class="dt">outFile =</span> xdf,
             <span class="dt">transforms =</span> <span class="kw">list</span>(
               <span class="dt">trainvalidate =</span> <span class="kw">factor</span>(
                   <span class="kw">ifelse</span>(<span class="kw">rbinom</span>(.rxNumRows, 
                                 <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> splitperc), 
                          <span class="st">&quot;train&quot;</span>, <span class="st">&quot;validate&quot;</span>)
               )
           ),
           <span class="dt">transformObjects =</span> <span class="kw">list</span>(<span class="dt">splitperc =</span> partition_size),
           <span class="dt">overwrite =</span> <span class="ot">TRUE</span>, ...)
  
  splitDS &lt;-<span class="st"> </span><span class="kw">rxSplit</span>(<span class="dt">inData =</span> xdf, 
                     <span class="co">#outFilesBase = ,</span>
                     <span class="dt">outFileSuffixes =</span> <span class="kw">c</span>(<span class="st">&quot;train&quot;</span>, <span class="st">&quot;validate&quot;</span>),
                     <span class="dt">splitByFactor =</span> <span class="st">&quot;trainvalidate&quot;</span>,
                     <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)
  
  <span class="kw">return</span>(splitDS) 
  
}</code></pre></div>
</section><section id="minimizing-io" class="slide level2">
<h1>Minimizing IO</h1>
<h3 id="transforms-in-rxsplit">Transforms in rxSplit</h3>
<p>While the above example does what we want it to do, it’s not very efficient. It requires two passes over the data, first to add the <code>trainvalidate</code> column, and then another to split it into train and validate sets. We could do all of that in a single step if we pass the transforms directly to <code>rxSplit</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">create_partition &lt;-<span class="st"> </span>function(<span class="dt">xdf =</span> mort_xdf,
                             <span class="dt">partition_size =</span> <span class="fl">0.75</span>, ...) {

  splitDS &lt;-<span class="st"> </span><span class="kw">rxSplit</span>(<span class="dt">inData =</span> xdf, 
                     <span class="dt">transforms =</span> <span class="kw">list</span>(
                       <span class="dt">trainvalidate =</span> <span class="kw">factor</span>(
                         <span class="kw">ifelse</span>(<span class="kw">rbinom</span>(.rxNumRows,
                                       <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> splitperc),
                                <span class="st">&quot;train&quot;</span>, <span class="st">&quot;validate&quot;</span>)
                         )
                       ),
                     <span class="dt">transformObjects =</span> <span class="kw">list</span>(<span class="dt">splitperc =</span> partition_size),
                     <span class="dt">outFileSuffixes =</span> <span class="kw">c</span>(<span class="st">&quot;train&quot;</span>, <span class="st">&quot;validate&quot;</span>),
                     <span class="dt">splitByFactor =</span> <span class="st">&quot;trainvalidate&quot;</span>,
                     <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)
  
  <span class="kw">return</span>(splitDS) 
  
}</code></pre></div>
</section><section id="generating-training-and-test-sets-1" class="slide level2">
<h1>Generating Training and Test Sets</h1>
<h3 id="list-of-xdfs">List of xdfs</h3>
<ul>
<li class="fragment">The <code>create_partition</code> function will output a list <code>xdfs</code></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mort_split &lt;-<span class="st"> </span><span class="kw">create_partition</span>(<span class="dt">reportProgress =</span> <span class="dv">0</span>)
<span class="kw">names</span>(mort_split) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;train&quot;</span>, <span class="st">&quot;validate&quot;</span>)
<span class="kw">lapply</span>(mort_split, rxGetInfo)</code></pre></div>
<pre><code>## $train
## File name: /home/alizaidi/mr4ds/Student-Resources/rmarkdown/mortgage.trainvalidate.train.xdf 
## Number of observations: 74877 
## Number of variables: 8 
## Number of blocks: 10 
## Compression type: zlib 
## 
## $validate
## File name: /home/alizaidi/mr4ds/Student-Resources/rmarkdown/mortgage.trainvalidate.validate.xdf 
## Number of observations: 25123 
## Number of variables: 8 
## Number of blocks: 10 
## Compression type: zlib</code></pre>
</section><section id="build-your-model" class="slide level2">
<h1>Build Your Model</h1>
<h3 id="model-formula">Model Formula</h3>
<ul>
<li class="fragment">Once you have a training dataset, the most appropriate next step is to estimate your model</li>
<li class="fragment"><code>RevoScaleR</code> provides a plethora of modeling functions to choose from: decision trees, ensemble trees, linear models, and generalized linear models</li>
<li class="fragment">All take a formula as the first object in their call</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">make_form &lt;-<span class="st"> </span>function(<span class="dt">xdf =</span> mort_xdf,
                      <span class="dt">resp_var =</span> <span class="st">&quot;default_flag&quot;</span>,
                      <span class="dt">vars_to_skip =</span> <span class="kw">c</span>(<span class="st">&quot;default&quot;</span>, <span class="st">&quot;trainvalidate&quot;</span>)) {
  
  <span class="kw">library</span>(stringr)
  
  non_incl &lt;-<span class="st"> </span><span class="kw">paste</span>(vars_to_skip, <span class="dt">collapse =</span> <span class="st">&quot;|&quot;</span>)
  
  x_names &lt;-<span class="st"> </span><span class="kw">names</span>(xdf)
  
  features &lt;-<span class="st"> </span>x_names[!<span class="kw">str_detect</span>(x_names, resp_var)]
  features &lt;-<span class="st"> </span>features[!<span class="kw">str_detect</span>(features, non_incl)]
  
  form &lt;-<span class="st"> </span><span class="kw">as.formula</span>(<span class="kw">paste</span>(resp_var, <span class="kw">paste0</span>(features, <span class="dt">collapse =</span> <span class="st">&quot; + &quot;</span>),
                           <span class="dt">sep  =</span> <span class="st">&quot; ~ &quot;</span>))
  
  <span class="kw">return</span>(form)
}

## Turns out, RevoScaleR already has a function for this
<span class="kw">formula</span>(mort_xdf, <span class="dt">depVar =</span> <span class="st">&quot;default_flag&quot;</span>, <span class="dt">varsToDrop =</span> <span class="kw">c</span>(<span class="st">&quot;defaultflag&quot;</span>, <span class="st">&quot;trainvalidate&quot;</span>))</code></pre></div>
<pre><code>## default_flag ~ creditScore + houseAge + yearsEmploy + ccDebt + 
##     year + default
## &lt;environment: 0x13b765e28&gt;</code></pre>
</section><section id="build-your-model-1" class="slide level2">
<h1>Build Your Model</h1>
<h3 id="modeling-function">Modeling Function</h3>
<ul>
<li class="fragment">Use the <code>make_form</code> function inside your favorite <code>rx</code> modeling function</li>
<li class="fragment">Default value will be a logistic regression, but can update the <code>model</code> parameter to any <code>rx</code> modeling function</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">make_form</span>()</code></pre></div>
<pre><code>## default_flag ~ creditScore + houseAge + yearsEmploy + ccDebt + 
##     year
## &lt;environment: 0x13b430940&gt;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">estimate_model &lt;-<span class="st"> </span>function(<span class="dt">xdf_data =</span> mort_split[[<span class="st">&quot;train&quot;</span>]],
                           <span class="dt">form =</span> <span class="kw">make_form</span>(xdf_data),
                           <span class="dt">model =</span> rxLogit, ...) {
  
  rx_model &lt;-<span class="st"> </span><span class="kw">model</span>(form, <span class="dt">data =</span> xdf_data, ...)
  
  <span class="kw">return</span>(rx_model)
  
  
}</code></pre></div>
</section><section id="build-your-model-2" class="slide level2">
<h1>Build Your Model</h1>
<h3 id="train-your-model-with-our-modeling-function">Train Your Model with Our Modeling Function</h3>
<ul>
<li class="fragment">Let us now train our logistic regression model for defaults using the <code>estimate_model</code> function from the last slide</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">default_model_logit &lt;-<span class="st"> </span><span class="kw">estimate_model</span>(mort_split$train, 
                                      <span class="dt">reportProgress =</span> <span class="dv">0</span>)
<span class="kw">summary</span>(default_model_logit)</code></pre></div>
<pre><code>## Call:
## model(formula = form, data = xdf_data, reportProgress = 0)
## 
## Logistic Regression Results for: default_flag ~ creditScore +
##     houseAge + yearsEmploy + ccDebt + year
## Data: xdf_data (RxXdfData Data Source)
## File name:
##     /home/alizaidi/mr4ds/Student-Resources/rmarkdown/mortgage.trainvalidate.train.xdf
## Dependent variable(s): default_flag
## Total independent variables: 6 
## Number of valid observations: 74877
## Number of missing observations: 0 
## -2*LogLikelihood: 2449.8945 (Residual deviance on 74871 degrees of freedom)
##  
## Coefficients:
##               Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept) -1.287e+03  7.129e+01 -18.054 2.22e-16 ***
## creditScore -7.340e-03  1.214e-03  -6.044 1.50e-09 ***
## houseAge     2.726e-02  7.799e-03   3.496 0.000473 ***
## yearsEmploy -2.332e-01  3.042e-02  -7.665 2.22e-16 ***
## ccDebt       1.226e-03  4.087e-05  30.007 2.22e-16 ***
## year         6.373e-01  3.549e-02  17.958 2.22e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Condition number of final variance-covariance matrix: 2.4349 
## Number of iterations: 9</code></pre>
</section><section id="building-additional-models" class="slide level2">
<h1>Building Additional Models</h1>
<ul>
<li class="fragment">We can change the parameters of the <code>estimate_model</code> function to create a different model relatively quickly</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">default_model_tree &lt;-<span class="st"> </span><span class="kw">estimate_model</span>(mort_split$train, 
                                     <span class="dt">model =</span> rxDTree,
                                     <span class="dt">minBucket =</span> <span class="dv">10</span>,
                                     <span class="dt">reportProgress =</span> <span class="dv">0</span>)
<span class="kw">summary</span>(default_model_tree)</code></pre></div>
<pre><code>##                     Length Class      Mode     
## frame                9     data.frame list     
## where                0     -none-     NULL     
## call                 5     -none-     call     
## cptable             35     -none-     numeric  
## method               1     -none-     character
## parms                3     -none-     list     
## control              9     -none-     list     
## splits              95     -none-     numeric  
## xvars                5     -none-     character
## variable.importance  5     -none-     numeric  
## ordered              5     -none-     logical  
## valid.obs            1     -none-     numeric  
## missing.obs          1     -none-     numeric  
## params              65     -none-     list     
## formula              3     formula    call</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># library(RevoTreeView)</span>
<span class="co"># plot(createTreeView(default_model_tree))</span></code></pre></div>
</section></section>
<section><section id="validation" class="titleslide slide level1"><h1>Validation</h1></section><section id="how-does-it-perform-on-unseen-data" class="slide level2">
<h1>How Does it Perform on Unseen Data</h1>
<h3 id="rxpredict-for-logistic-regression">rxPredict for Logistic Regression</h3>
<pre><code>## [1] TRUE</code></pre>
<ul>
<li class="fragment">Now that we have built our model, our next step is to see how it performs on data it has yet to see</li>
<li class="fragment">We can use the <code>rxPredict</code> function to score/validate our results</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">default_logit_scored &lt;-<span class="st"> </span><span class="kw">rxPredict</span>(default_model_logit,
                                   mort_split$validate,
                                   <span class="st">&quot;scored.xdf&quot;</span>,
                                  <span class="dt">writeModelVars =</span> <span class="ot">TRUE</span>, 
                                  <span class="dt">extraVarsToWrite =</span> <span class="st">&quot;default&quot;</span>,
                                  <span class="dt">predVarNames =</span> <span class="kw">c</span>(<span class="st">&quot;pred_logit_default&quot;</span>))
<span class="kw">rxGetInfo</span>(default_logit_scored, <span class="dt">numRows =</span> <span class="dv">2</span>)</code></pre></div>
<pre><code>## File name: /home/alizaidi/mr4ds/Student-Resources/rmarkdown/scored.xdf 
## Number of observations: 25123 
## Number of variables: 8 
## Number of blocks: 10 
## Compression type: zlib 
## Data (2 rows starting with row 1):
##   pred_logit_default default default_flag creditScore houseAge yearsEmploy
## 1       4.859631e-06       0      current         728       22           1
## 2       2.247419e-08       0      current         677       18           5
##   ccDebt year
## 1   4345 2000
## 2    505 2000</code></pre>
</section><section id="visualize-model-results" class="slide level2">
<h1>Visualize Model Results</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rxRoc</span>(<span class="dt">actualVarName =</span> <span class="st">&quot;default&quot;</span>, 
      <span class="dt">predVarNames =</span><span class="st">&quot;pred_logit_default&quot;</span>, 
      <span class="dt">data =</span> default_logit_scored)</code></pre></div>
<pre><code>##    threshold        predVarName sensitivity specificity
## 1       0.00 pred_logit_default  1.00000000   0.0000000
## 2       0.01 pred_logit_default  0.89473684   0.9380223
## 3       0.02 pred_logit_default  0.82456140   0.9626135
## 4       0.03 pred_logit_default  0.77192982   0.9742493
## 5       0.04 pred_logit_default  0.69298246   0.9792875
## 6       0.05 pred_logit_default  0.64912281   0.9837658
## 7       0.06 pred_logit_default  0.59649123   0.9865249
## 8       0.07 pred_logit_default  0.57017544   0.9889640
## 9       0.08 pred_logit_default  0.55263158   0.9905234
## 10      0.09 pred_logit_default  0.51754386   0.9915630
## 11      0.10 pred_logit_default  0.47368421   0.9924427
## 12      0.11 pred_logit_default  0.46491228   0.9932824
## 13      0.12 pred_logit_default  0.43859649   0.9938022
## 14      0.13 pred_logit_default  0.41228070   0.9944420
## 15      0.14 pred_logit_default  0.37719298   0.9953217
## 16      0.15 pred_logit_default  0.35964912   0.9955216
## 17      0.16 pred_logit_default  0.35087719   0.9958015
## 18      0.17 pred_logit_default  0.33333333   0.9962414
## 19      0.18 pred_logit_default  0.33333333   0.9967612
## 20      0.19 pred_logit_default  0.30701754   0.9970411
## 21      0.20 pred_logit_default  0.30701754   0.9974009
## 22      0.21 pred_logit_default  0.29824561   0.9976009
## 23      0.22 pred_logit_default  0.28947368   0.9977608
## 24      0.23 pred_logit_default  0.28070175   0.9979207
## 25      0.24 pred_logit_default  0.27192982   0.9979607
## 26      0.25 pred_logit_default  0.27192982   0.9980407
## 27      0.26 pred_logit_default  0.27192982   0.9981607
## 28      0.27 pred_logit_default  0.26315789   0.9982006
## 29      0.28 pred_logit_default  0.25438596   0.9982806
## 30      0.29 pred_logit_default  0.25438596   0.9985205
## 31      0.30 pred_logit_default  0.22807018   0.9987604
## 32      0.31 pred_logit_default  0.21929825   0.9988004
## 33      0.32 pred_logit_default  0.21052632   0.9988004
## 34      0.33 pred_logit_default  0.20175439   0.9988804
## 35      0.34 pred_logit_default  0.18421053   0.9989204
## 36      0.35 pred_logit_default  0.18421053   0.9990403
## 37      0.36 pred_logit_default  0.17543860   0.9991603
## 38      0.37 pred_logit_default  0.17543860   0.9992003
## 39      0.38 pred_logit_default  0.16666667   0.9992403
## 40      0.39 pred_logit_default  0.14912281   0.9992803
## 41      0.40 pred_logit_default  0.13157895   0.9993202
## 42      0.42 pred_logit_default  0.13157895   0.9993602
## 43      0.44 pred_logit_default  0.13157895   0.9994002
## 44      0.45 pred_logit_default  0.13157895   0.9994402
## 45      0.47 pred_logit_default  0.12280702   0.9994802
## 46      0.50 pred_logit_default  0.11403509   0.9995202
## 47      0.51 pred_logit_default  0.10526316   0.9996401
## 48      0.53 pred_logit_default  0.09649123   0.9997201
## 49      0.54 pred_logit_default  0.09649123   0.9997601
## 50      0.55 pred_logit_default  0.09649123   0.9998001
## 51      0.56 pred_logit_default  0.08771930   0.9998001
## 52      0.57 pred_logit_default  0.07894737   0.9998001
## 53      0.58 pred_logit_default  0.07894737   0.9998401
## 54      0.61 pred_logit_default  0.07894737   0.9999200
## 55      0.66 pred_logit_default  0.07017544   0.9999200
## 56      0.69 pred_logit_default  0.07017544   0.9999600
## 57      0.70 pred_logit_default  0.06140351   0.9999600
## 58      0.71 pred_logit_default  0.06140351   1.0000000
## 59      0.72 pred_logit_default  0.05263158   1.0000000
## 60      0.79 pred_logit_default  0.04385965   1.0000000
## 61      0.80 pred_logit_default  0.03508772   1.0000000
## 62      0.85 pred_logit_default  0.02631579   1.0000000
## 63      0.89 pred_logit_default  0.01754386   1.0000000
## 64      0.92 pred_logit_default  0.00877193   1.0000000
## 65      0.96 pred_logit_default  0.00000000   1.0000000</code></pre>
</section><section id="testing-a-second-model" class="slide level2">
<h1>Testing a Second Model</h1>
<h3 id="rxpredict-for-decision-tree">rxPredict for Decision Tree</h3>
<ul>
<li class="fragment">We saw how easy it was to train on different in the previous sections</li>
<li class="fragment">Similary simple to test different models</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">default_tree_scored &lt;-<span class="st"> </span><span class="kw">rxPredict</span>(default_model_tree,
                                  mort_split$validate,
                                  <span class="st">&quot;scored.xdf&quot;</span>,
                                  <span class="dt">writeModelVars =</span> <span class="ot">TRUE</span>,
                                 <span class="dt">predVarNames =</span> <span class="kw">c</span>(<span class="st">&quot;pred_tree_current&quot;</span>,
                                                  <span class="st">&quot;pred_tree_default&quot;</span>))</code></pre></div>
</section><section id="visualize-multiple-rocs" class="slide level2">
<h1>Visualize Multiple ROCs</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rxRocCurve</span>(<span class="st">&quot;default&quot;</span>,
           <span class="kw">c</span>(<span class="st">&quot;pred_logit_default&quot;</span>, <span class="st">&quot;pred_tree_default&quot;</span>),
           <span class="dt">data =</span> default_tree_scored)</code></pre></div>
<p><img src="3-modeling-scoring-rre_files/figure-revealjs/roc_multiple-1.png" width="768" /></p>
</section></section>
<section><section id="lab---estimate-other-models-using-the-functions-above" class="titleslide slide level1"><h1>Lab - Estimate Other Models Using the Functions Above</h1></section><section id="ensemble-tree-algorithms" class="slide level2">
<h1>Ensemble Tree Algorithms</h1>
<p>Two of the most predictive algorithms in the <code>RevoScaleR</code> package are the <code>rxBTrees</code> and <code>rxDForest</code> algorithms, for gradient boosted decision trees and random forests, respectively.</p>
<p>Use the above functions and estimate a model for each of those algorithms, and add them to the <code>default_tree_scored</code> dataset to visualize ROC and AUC metrics.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Starter code

default_model_forest &lt;-<span class="st"> </span><span class="kw">estimate_model</span>(mort_split$train, 
                                       <span class="dt">model =</span> rxDForest,
                                       <span class="dt">nTree =</span> <span class="dv">100</span>,
                                       <span class="dt">importance =</span> <span class="ot">TRUE</span>,
                                       <span class="dt">reportProgress =</span> <span class="dv">0</span>)

default_forest_scored &lt;-<span class="st"> </span><span class="kw">rxPredict</span>(default_model_forest,
                                  mort_split$validate,
                                 <span class="st">&quot;scored.xdf&quot;</span>, 
                                <span class="dt">type =</span> <span class="st">&#39;prob&#39;</span>,
                                <span class="dt">predVarNames =</span> <span class="kw">c</span>(<span class="st">&quot;pred_forest_current&quot;</span>, <span class="st">&quot;pred_forest_default&quot;</span>, <span class="st">&quot;pred_default&quot;</span>))

## same for rxBTrees

default_model_gbm &lt;-<span class="st"> </span><span class="kw">estimate_model</span>(mort_split$train,
                                    <span class="dt">model =</span> rxBTrees,
                                    <span class="dt">importance =</span> <span class="ot">TRUE</span>,
                                    <span class="dt">nTree =</span> <span class="dv">100</span>, <span class="dt">reportProgress =</span> <span class="dv">0</span>)

default_gbm_scored &lt;-<span class="st"> </span><span class="kw">rxPredict</span>(default_model_gbm,
                                  mort_split$validate,
                                 <span class="st">&quot;scored.xdf&quot;</span>,
                                <span class="dt">predVarNames =</span> <span class="kw">c</span>(<span class="st">&quot;pred_gbm_default&quot;</span>))</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># </span>
<span class="co"># rxRocCurve(actualVarName = &quot;default&quot;,</span>
<span class="co">#            predVarNames = c(&quot;pred_tree_default&quot;,</span>
<span class="co">#                             &quot;pred_logit_default&quot;,</span>
<span class="co">#                             &quot;pred_forest_default&quot;,</span>
<span class="co">#                             &quot;pred_gbm_default&quot;),</span>
<span class="co">#            data = &#39;scored.xdf&#39;)</span></code></pre></div>
</section></section>
<section><section id="more-advanced-topics" class="titleslide slide level1"><h1>More Advanced Topics</h1></section><section id="scoring-on-non-xdf-data-sources" class="slide level2">
<h1>Scoring on Non-XDF Data Sources</h1>
<h3 id="using-a-csv-as-a-data-source">Using a CSV as a Data Source</h3>
<ul>
<li class="fragment">The previous slides focused on using xdf data sources</li>
<li class="fragment">Most of the <code>rx</code> functions will work on non-xdf data sources</li>
<li class="fragment">For training, which is often an iterative process, it is recommended to use xdfs</li>
<li class="fragment">For scoring/testing, which requires just one pass through the data, feel free to use raw data!</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">csv_path &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="kw">rxGetOption</span>(<span class="st">&quot;sampleDataDir&quot;</span>),
                   <span class="st">&quot;mortDefaultSmall2009.csv&quot;</span>,
                   <span class="dt">sep =</span> <span class="st">&quot;/&quot;</span>)
<span class="kw">file.copy</span>(csv_path, <span class="st">&quot;mortDefaultSmall2009.csv&quot;</span>, <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mort_csv &lt;-<span class="st"> </span><span class="kw">RxTextData</span>(<span class="st">&quot;mortDefaultSmall2009.csv&quot;</span>)</code></pre></div>
</section><section id="regression-tree" class="slide level2">
<h1>Regression Tree</h1>
<ul>
<li class="fragment">For a slightly different model, we will estimate a regression tree.</li>
<li class="fragment">Just change the parameters in the <code>estimate_model</code> function</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tree_model_ccdebt &lt;-<span class="st"> </span><span class="kw">estimate_model</span>(<span class="dt">xdf_data =</span> mort_split$train,
                                    <span class="dt">form =</span> <span class="kw">make_form</span>(mort_split$train,
                                                     <span class="st">&quot;ccDebt&quot;</span>,
                                                     <span class="dt">vars_to_skip =</span> <span class="kw">c</span>(<span class="st">&quot;default_flag&quot;</span>,
                                                                      <span class="st">&quot;trainvalidate&quot;</span>)),
                                    <span class="dt">model =</span> rxDTree)
<span class="co"># plot(RevoTreeView::createTreeView(tree_model_ccdebt))</span></code></pre></div>
</section><section id="test-on-csv" class="slide level2">
<h1>Test on CSV</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">if (<span class="kw">file.exists</span>(<span class="st">&quot;mort2009predictions.xdf&quot;</span>)) <span class="kw">file.remove</span>(<span class="st">&quot;mort2009predictions.xdf&quot;</span>)</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rxPredict</span>(tree_model_ccdebt,
          <span class="dt">data =</span> mort_csv,
          <span class="dt">outData =</span> <span class="st">&quot;mort2009predictions.xdf&quot;</span>,
          <span class="dt">writeModelVars =</span> <span class="ot">TRUE</span>)

mort_2009_pred &lt;-<span class="st"> </span><span class="kw">RxXdfData</span>(<span class="st">&quot;mort2009predictions.xdf&quot;</span>)
<span class="kw">rxGetInfo</span>(mort_2009_pred, <span class="dt">numRows =</span> <span class="dv">1</span>)</code></pre></div>
<pre><code>## File name: /home/alizaidi/mr4ds/Student-Resources/rmarkdown/mort2009predictions.xdf 
## Number of observations: 10000 
## Number of variables: 7 
## Number of blocks: 1 
## Compression type: zlib 
## Data (1 row starting with row 1):
##   ccDebt_Pred ccDebt creditScore houseAge yearsEmploy year default
## 1    4938.398   3661         701       23           2 2009       0</code></pre>
</section></section>
<section><section id="multiclass-classification" class="titleslide slide level1"><h1>Multiclass Classification</h1></section><section id="convert-year-to-factor" class="slide level2">
<h1>Convert Year to Factor</h1>
<ul>
<li class="fragment">We have seen how to estimate a binary classification model and a regression tree</li>
<li class="fragment">How would we estimate a multiclass classification model?</li>
<li class="fragment">Let’s try to predict mortgage origination based on other variables</li>
<li class="fragment">Use <code>rxFactors</code> to convert <em>year</em> to a <em>factor</em> variable</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mort_xdf_factor &lt;-<span class="st"> </span><span class="kw">rxFactors</span>(<span class="dt">inData =</span> mort_xdf,
                             <span class="dt">factorInfo =</span> <span class="kw">c</span>(<span class="st">&quot;year&quot;</span>),
                             <span class="dt">outFile =</span> <span class="st">&quot;mort_year.xdf&quot;</span>,
                             <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)</code></pre></div>
</section><section id="convert-year-to-factor-1" class="slide level2">
<h1>Convert Year to Factor</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rxGetInfo</span>(mort_xdf_factor, <span class="dt">getVarInfo =</span> <span class="ot">TRUE</span>, <span class="dt">numRows =</span> <span class="dv">4</span>)</code></pre></div>
<pre><code>## File name: /home/alizaidi/mr4ds/Student-Resources/rmarkdown/mort_year.xdf 
## Number of observations: 1e+05 
## Number of variables: 7 
## Number of blocks: 10 
## Compression type: zlib 
## Variable information: 
## Var 1: creditScore, Type: integer, Low/High: (470, 925)
## Var 2: houseAge, Type: integer, Low/High: (0, 40)
## Var 3: yearsEmploy, Type: integer, Low/High: (0, 14)
## Var 4: ccDebt, Type: integer, Low/High: (0, 14094)
## Var 5: year
##        10 factor levels: 2000 2001 2002 2003 2004 2005 2006 2007 2008 2009
## Var 6: default, Type: integer, Low/High: (0, 1)
## Var 7: default_flag
##        2 factor levels: current default
## Data (4 rows starting with row 1):
##   creditScore houseAge yearsEmploy ccDebt year default default_flag
## 1         691       16           9   6725 2000       0      current
## 2         691        4           4   5077 2000       0      current
## 3         743       18           3   3080 2000       0      current
## 4         728       22           1   4345 2000       0      current</code></pre>
</section><section id="estimate-multiclass-classification" class="slide level2">
<h1>Estimate Multiclass Classification</h1>
<ul>
<li class="fragment">You know the drill! Change the parameters in <code>estimate_model</code>:</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tree_multiclass_year &lt;-<span class="st"> </span><span class="kw">estimate_model</span>(<span class="dt">xdf_data =</span> mort_xdf_factor,
                                    <span class="dt">form =</span> <span class="kw">make_form</span>(mort_xdf_factor,
                                                     <span class="st">&quot;year&quot;</span>,
                                                     <span class="dt">vars_to_skip =</span> <span class="kw">c</span>(<span class="st">&quot;default&quot;</span>,
                                                                      <span class="st">&quot;trainvalidate&quot;</span>)),
                                    <span class="dt">model =</span> rxDTree)</code></pre></div>
</section><section id="predict-multiclass-classification" class="slide level2">
<h1>Predict Multiclass Classification</h1>
<ul>
<li class="fragment">Score the results</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">multiclass_preds &lt;-<span class="st"> </span><span class="kw">rxPredict</span>(tree_multiclass_year,
                              <span class="dt">data =</span> mort_xdf_factor,
                              <span class="dt">writeModelVars =</span> <span class="ot">TRUE</span>,
                              <span class="dt">outData =</span> <span class="st">&quot;multi.xdf&quot;</span>,
                              <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)</code></pre></div>
</section><section id="predict-multiclass-classification-1" class="slide level2">
<h1>Predict Multiclass Classification</h1>
<ul>
<li class="fragment">View the results</li>
<li class="fragment">Predicted/scored column for each level of the response</li>
<li class="fragment">Sum up to one</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rxGetInfo</span>(multiclass_preds, <span class="dt">numRows =</span> <span class="dv">3</span>)</code></pre></div>
</section><section id="conclusion" class="slide level2">
<h1>Conclusion</h1>
<h3 id="thanks-for-attending">Thanks for Attending!</h3>
<ul>
<li class="fragment">Any questions?</li>
<li class="fragment">Try different models!</li>
<li class="fragment">Try modeling with <code>rxDForest</code>, <code>rxBTrees</code>: have significantly higher predictive accuracy, somewhat less interpretability</li>
</ul>
</section></section>
    </div>
  </div>

  <script src="3-modeling-scoring-rre_files/reveal.js-3.3.0/lib/js/head.min.js"></script>
  <script src="3-modeling-scoring-rre_files/reveal.js-3.3.0/js/reveal.js"></script>

  <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        // Push each slide change to the browser history
        history: true,
        // Vertical centering of slides
        center: true,
        // Transition style
        transition: 'default', // none/fade/slide/convex/concave/zoom
        // Transition style for full page slide backgrounds
        backgroundTransition: 'default', // none/fade/slide/convex/concave/zoom

        // Optional reveal.js plugins
        dependencies: [
          { src: '3-modeling-scoring-rre_files/reveal.js-3.3.0/plugin/notes/notes.js', async: true },
          { src: '3-modeling-scoring-rre_files/reveal.js-3.3.0/plugin/zoom-js/zoom.js', async: true },
        ]
      });
    </script>
  <!-- dynamically load mathjax for compatibility with self-contained -->
  <script>
    (function () {
      var script = document.createElement("script");
      script.type = "text/javascript";
      script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
      document.getElementsByTagName("head")[0].appendChild(script);
    })();
  </script>

<script>
  (function() {
    if (window.jQuery) {
      Reveal.addEventListener( 'slidechanged', function(event) {  
        window.jQuery(event.previousSlide).trigger('hidden');
        window.jQuery(event.currentSlide).trigger('shown');
      });
    }
  })();
</script>


  </body>
</html>
